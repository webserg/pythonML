<!DOCTYPE html>
<!-- saved from url=(0082)https://labs.vocareum.com/web/28286/96716.0/ASNLIB/public/docs/lang/en/README.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width initial-scale=1">
<title>lab-4-ecs-scaling</title><link href="./css" rel="stylesheet" type="text/css"><style type="text/css">html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 40px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.html-for-mac .inline-math-svg .MathJax_SVG { vertical-align: 0.2px; }
.md-math-block .MathJax_SVG_Display { text-align: center; margin: 0px; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; overflow-y: hidden; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: var(--monospace); }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: 400; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { transition: none 0s ease 0s; }
.MathJax_SVG_Display svg { vertical-align: middle !important; margin-bottom: 0px !important; margin-top: 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
svg[id^="mermaidChart"] { line-height: 1em; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
mark .md-meta { color: rgb(0, 0, 0); opacity: 0.3 !important; }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table tr td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}
table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}


</style>
</head>
<body class="typora-export os-windows">
<div id="write" class=""><p>&nbsp;</p><p><span>[*version_1.0.0] </span></p><h1><a name="lab-4---scaling-with-ecs" class="md-header-anchor"></a><span>Lab 4 - Scaling with ECS</span></h1><p><span>After completing this exercise, you will learn how to work with dynamic port mapping and ECS, container autoscaling, and deploying an ECS task onto an AWS Fargate Cluster.</span></p><h2><a name="story-continued" class="md-header-anchor"></a><span>Story continued...</span></h2><p><span>At this point your students are confident that they can use Elastic Beanstalk to deploy their applications and are comfortable working directly with ECS.  However they are all very keen to learn how to scale containers based upon load as well as how to maximize the utilization of their existing EC2 instances.</span></p><p><span>You decide that it would be a good time to introduce to them the idea of dynamic port mapping to allow them to make better use of their machines.</span></p><p><span>To wrap up you are looking forward to sharing the idea of Fargate with them.  There you will demo how easy it is to adapt an environment to be Fargate compatible while discussing it's pros and cons.</span></p><h2><a name="game-plan" class="md-header-anchor"></a><span>Game plan</span></h2><ol start=""><li><span>Discuss what tight packing means and how dynamic ports work with ECS.</span></li><li><span>Set up 10 containers on ECS to show dynamic port mapping working.</span></li><li><span>Show them how they can set up an ECS Service to run their tasks.</span></li><li><span>Demo how to set up task load balancing.</span></li><li><span>Add autoscaling.</span></li><li><span>Deploy the price API on Fargate and share the API endpoint.</span></li><li><span>Close by discussing "where to go from here"</span></li></ol><h2><a name="prepare-the-exercise" class="md-header-anchor"></a><span>Prepare the exercise</span></h2><ol><li><p><span>At the top of these instructions, click </span><strong><span>Start Lab</span></strong><span> to launch your lab.</span></p></li><li><p><span>A Start Lab panel opens displaying the lab status.</span></p></li><li><p><span>Wait until you see the message "</span><strong><span>Lab status: ready</span></strong><span>", then click the </span><strong><span>X</span></strong><span> to close the Start Lab panel.</span></p></li><li><p><span>At the top of these instructions, click </span><strong><span>AWS</span></strong></p><p><span>This will open the AWS Management Console in a new browser tab. The system will automatically log you in.    </span></p></li></ol><blockquote><p><strong><span>TIP:</span></strong><span> If a new browser tab does not open, there will typically be a banner or icon at the top of your browser indicating that your browser is preventing the site from opening pop-up windows. Click on the banner or icon and choose "Allow pop ups."</span></p></blockquote><p><span>Arrange the AWS Management Console tab so that it displays along side these instructions. Ideally, you will be able to see both browser tabs at the same time, to make it easier to follow the lab steps.</span></p><p><span>Before you can start this exercise.  You need to import some files and install some modules in the AWS Cloud9 environment that has been prepared for you.</span></p><h2><a name="setup" class="md-header-anchor"></a><span>Setup</span></h2><ol start=""><li><p><span>Ensure you are in </span><strong><span>Cloud9</span></strong><span>.  Choose </span><strong><span>Services</span></strong><span> and search for </span><strong><span>Cloud9</span></strong><span> and </span><strong><span>Open IDE</span></strong><span>.  Ensure that you are in the right path.</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> /home/ec2-user/environment</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p><span>You will need get the files that will be used for this exercise.  Go to the Cloud9 </span><strong><span>bash terminal</span></strong><span> (at the bottom of the page) and run the following </span><code>wget</code><span> command:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">wget</span> https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/DEV-AWS-MO-Containers/lab-4-ecs-scaling.zip</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li><li><p><span>You should also see that a root folder called </span><strong><span>ContainersLab</span></strong><span> with a </span><code>lab-4-ecs-scaling.zip</code><span> file has been downloaded and added to your AWS Cloud9 filesystem (on the top left). </span></p></li><li><p><span>To unzip the file.  Run the following command:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">unzip lab-4-ecs-scaling.zip</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>This may take a few moments.  </span></p></li><li><p><span>To keep things clean.  Run the following commands to remove the zip file.  </span><em><span>You can also close the other AWS console tab</span></em><span>.</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">rm</span> lab-4-ecs-scaling.zip</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p>💁‍♂<span> You will ALSO need to run a </span><code>lab_helper</code><span> file too.  Otherwise you would have to set up ECR and build your images.  You would also need to configure the ECS CLI tools and create an ECS </span><code>fancy</code><span> cluster config.  Finally launch a network of EC2 instances </span><strong><span>all over again</span></strong><span> due to this lab environment resetting.</span></p></li><li><p><span>Do the following:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> ~/environment/resources</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>Then:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">chmod</span> <span class="cm-operator">+</span>x lab_helper.sh </span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>Finally:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">./lab_helper.sh</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li></ol><p><em>⏰<span> This can take up to 5 minutes (ignore warnings)</span></em><span>.</span></p><p><span>This will output lots of stuff to the terminal as it runs.</span></p><p><span>It may look like it's stalled as it installs python but </span><em><span>eventually</span></em><span> you will see that it creates an </span><code>aws-elastic-beanstalk-cli-setup</code><span> folder (which you can ignore, although don't delete it).  It will output information and will finally print the word </span><strong><span>complete</span></strong><span>.</span></p><p>💁‍♂<span> Make a note of the outputted information. Perhaps copy and paste it into a text file, as you will need this information later.</span></p><p><span>💁‍♂</span><em><span>Your information will be different than the following.</span></em></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">VPC created: vpc-04db469e14fcba11f</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Security Group created: sg-0bb60cfa247e8a894</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Subnet created: subnet-07fa80fc8f32c315f</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Subnet created: subnet-041730a5c01565ed5</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Cluster creation succeeded.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">service_api_image_uri</span><span class="cm-operator">=</span><span class="cm-number">048153540315</span>.dkr.ecr.us-west-2.amazonaws.com/service-api</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">price_api_image_uri</span><span class="cm-operator">=</span><span class="cm-number">048153540315</span>.dkr.ecr.us-west-2.amazonaws.com/price-api</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><p>💁‍♂<span> Ok, now you can move on with your demo without having to repeat a load of steps for your students.</span></p><h3><a name="step-1---tight-packing-and-dynamic-ports" class="md-header-anchor"></a><span>Step 1 - Tight packing and Dynamic Ports</span></h3><p><span>You start today's session by talking to your students about the concept of </span><strong><span>tight packing</span></strong><span> and </span><strong><span>dynamic port allocation</span></strong><span>.</span></p><p><span>You remind them that </span><u><span>before</span></u><span> they used Elastic Beanstalk to run each container in its own task, which is not really making best use of the machines.</span></p><p><span>You had something like this (below) when you used </span><code>eb up</code><span> which is essentially a different method of calling </span><code>docker-compose up</code><span>.</span></p><p><span>It would create a structure like this (as they have seen before):</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">elasticbeanstalk_price-api-1</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">elasticbeanstalk_service-api-1</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>However, unlike with Elastic Beanstalk, with ECS you have the ability to run </span><u><span>many containers on the same host</span></u><span>.  You advise them it would look a bit more like this:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-1</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_service-api-1</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-2</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_service-api-2</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-3</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_service-api-3</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-4</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-5</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-6</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-7</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 230px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre><p><span>You go on to give an example.</span></p><p><span>If say the </span><code>service-api</code><span> is not under load but the </span><code>price-api</code><span> is, you want to be able to tightly pack (squeeze) more </span><code>price-apis</code><span> onto this particular host. </span></p><p><span>The challenge you would have, and the reason why you can't do this with Elastic Beanstalk, is that it uses </span><u><span>1 task per host</span></u><span>. This is due to the hard coupling of the containers exposed on port </span><strong><span>3000</span></strong><span> to their respective host ports of </span><strong><span>8080</span></strong><span> and </span><strong><span>8081</span></strong><span>.</span></p><p><span>Once you have used up </span><strong><span>8080</span></strong><span> and </span><strong><span>8081</span></strong><span> on that Public IP (think 1 Elastic Network Interface per host for now).  You </span><u><span>can't use any more</span></u><span> as that would cause a </span><strong><span>port conflict.</span></strong></p><p><span>Meaning you are not making good use of the host.</span></p><p><span>You give them the good news, and tell them that there is a solution to this.  </span></p><p><span>The solution is to use ECS and select the </span><strong><span>BRIDGE</span></strong><span> network (which is the default) instead of using the </span><strong><span>host</span></strong><span> or </span><strong><span>AWSVPC</span></strong><span> networks.  </span></p><p><span>What this means is that you can expose the </span><strong><span>service-api's</span></strong><span> port </span><strong><span>3000</span></strong><span> to </span><u><span>whatever host port is available at that point in time</span></u><span>.  Basically something in the ephemeral port range. </span></p><p>💁‍♂<span> </span><em><span>We will handle the </span><code>price-api</code><span> differently with Fargate later. For now you are just going to show them the </span><code>service-api</code></em></p><p><span>You go on to sat that if you </span><em><span>let ECS choose ephemeral ports</span></em><span>, it would end up looking something a but like this:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang=""><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-1 3000 &gt; 515641</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_service-api-1 3000 &gt; 515642</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-2 3000 &gt; 515643</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_service-api-2 3000 &gt; 515644</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-3 3000 &gt; 515645</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_service-api-3 3000 &gt; 515646</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-4 3000 &gt; 515647</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-5 3000 &gt; 515648</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-6 3000 &gt; 515649</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">esc_price-api-7 3000 &gt; 515650</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 230px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre><p><span>One of your students asks: "</span><em><span>Won't there be a conflic on port 3000 tho'?</span></em><span>"</span></p><p><span>You explain that the reason there is no conflict on port </span><strong><span>3000</span></strong><span> because they are exposed from separate containers with their own internal IP range.  </span></p><p><span>You recap that this process is called </span><strong><span>dynamic port mapping</span></strong><span>, and is only available on the </span><em><span>default</span></em><span> (</span><strong><span>bridge network</span></strong><span>).</span></p><h3><a name="step-2--set-up-dynamic-port-mapping-on-ecs" class="md-header-anchor"></a><span>Step 2 -Set up Dynamic Port mapping on ECS</span></h3><p><span>Now that your students understand what dynamic port mapping is conceptually, you are going to demo how to use a </span><strong><span>docker-compose</span></strong><span> file to create a </span><strong><span>task definition</span></strong><span>.  </span></p><p><span>You are only going to demo the </span><code>service-api</code><span> here.</span></p><ol start=""><li><p><span>Back in </span><strong><span>Cloud9</span></strong><span>.</span></p></li><li><p><strong><span>Open</span></strong><span> (double click) </span><code>resources/for_ecs/service-api/docker-compose.yaml</code><span>.  </span></p><p><span>Just like in the last lab.  You will need to swap out the </span><code>&lt;FMI&gt;</code><span> with your </span><code>service-api</code><span> image URI that you made a note of earlier.</span></p><p>💁‍♂<span> </span><em><span>This will be in the output from the lab-helper script.</span></em></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">version: <span class="cm-string">"3.0"</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">services:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  service-api:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  image: <span class="cm-string">"&lt;FMI&gt;"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ports:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-</span> <span class="cm-string">"0:3000"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 138px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre><p><span>Example:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">version: <span class="cm-string">"3.0"</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">services:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  service-api:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  image: <span class="cm-string">"048153540315.dkr.ecr.us-west-2.amazonaws.com/service-api"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ports:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-</span> <span class="cm-string">"0:3000"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 138px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre><p>📓<span> You highlight some key differences vs the last docker compose to your students.  Notably the lack of volume info and network details.  </span>💁‍♂<span> </span><em><span>You are leaving the volume stuff out for now, as you have covered storage with them already, and want to keep things simple. You don't trust the demo-gods when it comes to adding more complexity.</span></em></p><p>📓<span> Also note the version is 3.0 and NOT 3.7, as ECS only accepts major versions.</span></p><p>📓<span> Note the port is set to </span><code>0:3000</code><span> which is how the dynamic port mapping magic works.</span></p></li><li><p><strong><span>Save</span></strong><span> the file.</span></p></li><li><p>📓<span> Remind your students that creating a task definition requires the </span><code>ecs-params</code><span> file which can be viewed at </span><code>/resources/for_ecs/service-api/ecs-params.yaml</code><span>  </span></p><p><span>Just replace the </span><code>&lt;FMI&gt;</code><span> with your task execution role.  You get the prepared role by running this:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aws iam get-role <span class="cm-attribute">--role-name</span> fancy-task-role | <span class="cm-builtin">grep</span> Arn</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>To get:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"Arn"</span>: <span class="cm-string">"arn:aws:iam::771152176606:role/fancy-task-role"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>Then use it here and save the file:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="yaml"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">version</span><span class="cm-meta">: </span><span class="cm-number">1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">task_definition</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  task_execution_role</span><span class="cm-meta">: </span><span class="cm-string">"&lt;FMI&gt;"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  task_size</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  cpu_limit</span><span class="cm-meta">: </span><span class="cm-string">"512"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  mem_limit</span><span class="cm-meta">: </span><span class="cm-string">"256"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 138px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre><p><span>Example:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="yaml"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">version</span><span class="cm-meta">: </span><span class="cm-number">1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">task_definition</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  task_execution_role</span><span class="cm-meta">: </span><span class="cm-string">"arn:aws:iam::048153540315:role/fancy-task-role"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  task_size</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  cpu_limit</span><span class="cm-meta">: </span><span class="cm-string">"512"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  mem_limit</span><span class="cm-meta">: </span><span class="cm-string">"256"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 138px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre><p><span>You advise your students that this task execution role is less furnished with permissions than your role on your host EC2.  Only the host in </span><code>ECS-ECS</code><span> ever needs to talk to </span><strong><span>ECS api</span></strong><span>.  In the case of </span><code>ECS-Fargate</code><span> this is managed for us. Hence ECS access is not needed in our task policy. </span></p><p><span>If you had to reach other AWS services you would just supplement this task role's permissions using IAM like normal. </span></p><p><span>Now you are ready to demo launching your new dynamic port mapping version of your </span><code>service-api</code><span> task onto your fleet of EC2s (that was prepared in the starter script).</span></p></li><li><p><span>Run this (ensuring you are in the right directory):</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> ~/environment/resources/for_ecs/service-api</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ecs-cli compose <span class="cm-attribute">--file</span> docker-compose.yaml <span class="cm-attribute">--ecs-params</span> ecs-params.yaml <span class="cm-attribute">--region</span> us-west-2 <span class="cm-attribute">--project-name</span> fancy-project <span class="cm-attribute">--cluster-config</span> fancy-cluster <span class="cm-attribute">--cluster</span> fancy-cluster create</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p><span>This is just like before in Lab 3 where you showed them creating a task definition from a </span><code>docker compose</code><span> and an </span><code>ecs-params</code><span> file.  </span></p><p><span>You should see the following:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">INFO[0000] Using ECS task definition &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-def">TaskDefinition</span><span class="cm-operator">=</span><span class="cm-string">"fancy-project:1"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>Now on to </span><strong><span>Amazon ECS</span></strong><span>, where you will launch everything.</span></p></li><li><p><span>Choose </span><strong><span>AWS Cloud9</span></strong><span> and </span><strong><span>Go To Your Dashboard</span></strong><span>.  Choose </span><strong><span>Services</span></strong><span> and search for </span><strong><span>ECS</span></strong><span>.  </span></p></li><li><p><span>Choose </span><strong><span>Task Definitions</span></strong><span> at the left under </span><strong><span>Amazon ECS</span></strong><span>.  </span></p></li><li><p><span>Click on the  </span><code>fancy-project</code><span> task hyperlink to view all your versions.</span></p></li><li><p><span>Then </span><strong><span>select the checkbox</span></strong><span> next to </span><code>fancy-project:</code><span>.  Choose </span><strong><span>Actions</span></strong><span> and </span><strong><span>Run Task</span></strong><span>.  </span></p></li><li><p><span>Select </span><strong><span>Switch to launch type</span></strong><span> from the hyperlink.  Instead of using the capacity provider option.</span></p></li><li><p><span>Choose </span><strong><span>EC2</span></strong><span>.  For </span><strong><span>Number of tasks</span></strong><span> change the number to </span><code>10</code><span>.  </span></p></li><li><p><span>Leave </span><strong><span>Task Group</span></strong><span> empty</span></p></li><li><p><span>Leave </span><strong><span>Task Placement</span></strong><span> as </span><strong><span>AZ Balanced Spread</span></strong></p></li><li><p><span>Leave </span><strong><span>Advanced Options</span></strong><span> alone.</span></p></li><li><p><span>Choose </span><strong><span>Run Task</span></strong><span>.  </span></p></li><li><p><span>Refresh </span><u><span>straight away</span></u><span> and you should be able to show your students something similar to this:</span></p></li></ol><p><img src="./Screen Shot 2019-11-20 at 11.37.28 AM.png" referrerpolicy="no-referrer" alt="Screen Shot 2019-11-20 at 11.37.28 AM"></p><ol start="17"><li><span>If you widen the </span><code>task definition</code><span> column.  You will see we have 10 tasks being run from the </span><strong><span>fancy-project:</span></strong><span> definition.</span></li><li><span>Choose one of the tasks that contain </span><code>fancy-project:</code><span> in the </span><strong><span>Task definition</span></strong><span> by clicking the hyperlink on the Task column.  Then expand the </span><code>service-api</code><span> under </span><strong><span>Name</span></strong><span>.</span></li><li><span>Under </span><strong><span>External Link</span></strong><span> choose the </span><strong><span>IP</span></strong><span>.  </span></li></ol><p>📓<span> Notice the page </span><u><span>will not load</span></u><span> and has an ephemeral port like </span><strong><span>:32768</span></strong><span> or something similar. You ask your students why this is.</span></p><p><span>Nobody raises their hand, even after you give them plenty of time to answer.</span></p><p><span>You go on to clarify that this is because the instances (hosts) have a </span><strong><span>security group</span></strong><span> on them that is </span><strong><span>only</span></strong><span> allowing port </span><strong><span>8080</span></strong><span> to the outside world.  For now, you want to allow for </span><u><span>all traffic</span></u><span> across all possible </span><em><span>dynamic</span></em><span> </span><strong><span>ephemeral ports</span></strong><span>.</span></p><ol start="20"><li><p><span>Keep that ephemeral page window open (hanging) for now, you'll come back to it in a sec.</span></p></li><li><p><span>To do this choose the </span><strong><span>Amazon ECS</span></strong><span> tab that should still be open.  </span></p></li><li><p><span>Choose </span><strong><span>Services</span></strong><span> and search for </span><strong><span>EC2</span></strong><span>.  Under </span><strong><span>NETWORK &amp; SECURITY</span></strong><span> choose </span><strong><span>Security Groups</span></strong><span>. </span></p></li><li><p><span>Choose the SG with </span><strong><span>fancy-cluster</span></strong><span> in the name.</span></p></li><li><p><span>Jot down the security group id as </span><u><span>you will need it later</span></u><span>.  It will look a bit like this: </span><code>sg-074cfca993e6fdd4b</code><span>.  </span>💁‍♂<span> </span><em><span>This is also output after you ran the lab-helper script</span></em><span>.</span></p></li><li><p><span>Choose the </span><strong><span>Inbound</span></strong><span> tab and select </span><strong><span>Edit</span></strong><span>.  </span></p></li><li><p><span>Change the </span><strong><span>Port Range</span></strong><span> from </span><code>8080</code><span> to </span><code>0-65535</code><span> from source </span><strong><span>anywhere</span></strong><span>.  </span></p></li><li><p><span>Choose </span><strong><span>Save</span></strong><span>.  </span></p></li><li><p><span>Try refreshing that ephemeral port page and you should now get the:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">hello this is the root of the <span class="cm-builtin">service</span> api</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li></ol><p><span>Feel free to try that on </span><em><span>any</span></em><span> of the 10 tasks.  They should </span><u><span>all</span></u><span> work.</span></p><p><strong><span>Awesome</span></strong><span> you are now using </span><strong><span>dynamic port mapping</span></strong><span> with ECS and are </span><strong><span>tightly packing your machines</span></strong><span>.  You are able to show your students that you have </span><strong><span>10 containers live on line</span></strong><span> exposed on </span><strong><span>ephemera</span></strong><span>l ports.  </span></p><p><span>Before you proceed you do some cleanup and stop all of the tasks.</span></p><ol start="29"><li><span>Choose </span><strong><span>Services</span></strong><span> and </span><strong><span>ECS</span></strong><span>.  Choose </span><strong><span>Clusters</span></strong><span> under </span><strong><span>Amazon ECS</span></strong><span>.</span></li><li><span>Select the </span><strong><span>fancy-cluster</span></strong><span> &gt;.</span></li><li><span>Choose the </span><strong><span>Tasks</span></strong><span> tab and select </span><strong><span>Stop All</span></strong><span>.  </span></li><li><span>Type </span><code>STOP ALL</code><span> and choose </span><strong><span>Stop all</span></strong><span>.  </span></li></ol><h3><a name="step-3---ecs-service" class="md-header-anchor"></a><span>Step 3 - ECS Service</span></h3><p><span>One of you keener students raises his hand and asks you a question.</span></p><p><span>He is asking if you having 10 tasks running each with their own IP PORT combo.  Don't you need to find some way of routing to them?</span></p><p><span>He further offers that you could at this point use Route53 to round robin all these 10 IP:PORT combos but wanted to know if there was a better way to do this.  Maybe a load balancer and somehow keep it in sync with the tasks in ECS?</span></p><p><span>This was a </span><strong><span>great</span></strong><span> question and was JUST what you wanted someone to ask. </span></p><p><span>This gives you the perfect segue into talking about </span><strong><span>container load balancing</span></strong><span> and the </span><strong><span>ECS Service</span></strong><span> option.</span></p><p><span>You go on to explain to your students that containers often die and get respawned, and in some cases they are added and deleted by you manually.  </span></p><p><span>You can tell from their reaction (they are shaking their heads) that they recognize that trying to keep track of all these IP and Port combinations would be a nightmare.</span></p><p><span>You tell them that you are going to demo using an Application Load Balancer </span><code>ALB</code><span> and then link it to the  the </span><code>ECS-Service</code><span> to help keep track of targets and all their dynamic ports.</span></p><p><span>You are also going to show them how they can create a </span><strong><span>target group</span></strong><span> for the </span><code>service-api</code><span> tasks and have the ALB simply route traffic via a path. Namely </span><code>/service</code><span>.</span></p><p>📓<span> You explain that although a load balancer can route traffic and even do health checks.  It is not responsible for maintaining a set of tasks.  That would be the responsibility of some kind of ECS container autoscaling feature.</span></p><p><span>For that you would need to demo the </span><strong><span>ECS "service"</span></strong><span>. </span>💁‍♂<span> </span><em><span>Yes I think it's unhelpfully named too. ;)</span></em></p><p><span>You go on to say that his </span><strong><span>ECS Service</span></strong><span> essentially launches (runs) tasks like you have been showing them manually.  It is designed to ensure that </span><em><span>no mater what</span></em><span> ECS will always try to maintain a set number of running tasks.</span></p><p><span>📓 This is subtly different than production level autoscaling. We are not awaiting some CloudWatch metric to determine if we need to scale the number of tasks up or down. </span>💁‍♂<span> </span><em><span>Think of this as more like "task count locking" than "autoscaling".</span></em></p><p><span>This simply says "try and maintain 10 tasks in a running state and pay no attention to load or any other metric".</span></p><p><span>In this next step you are going to need to demo multiple things at once.</span></p><p><span>You tell your students that although you will be demoing adding an ALB in a bit, it can get a bit confusing if you combine too many steps together.  </span></p><p><span>You think that the best approach is to create the ECS Service first.  Then show how that service works </span><u><span>first</span></u><span> and </span><em><span>then</span></em><span> get fancy and add the load balancer.</span></p><ol start=""><li><p><span>Choose the </span><strong><span>ECS</span></strong><span> tab that should still be open.</span></p></li><li><p><span>Choose </span><strong><span>Clusters</span></strong><span> under </span><strong><span>Amazon ECS</span></strong><span> and choose the </span><strong><span>fancy-cluster &gt;</span></strong><span>.</span></p></li><li><p><span>Under </span><strong><span>Services</span></strong><span> choose </span><strong><span>Create</span></strong><span>.  Choose </span><strong><span>EC2</span></strong><span> under </span><strong><span>Launch type</span></strong><span>.</span></p></li><li><p><span>Leave </span><strong><span>Task Definition</span></strong><span> as is.  The </span><strong><span>Cluster</span></strong><span> should be </span><code>fancy-cluster</code><span>.</span></p></li><li><p><span>For </span><strong><span>Service name</span></strong><span> set this to </span><code>fancy-service-for-service-api</code><span>.</span></p></li><li><p><span>Leave </span><strong><span>Service type</span></strong><span> as </span><strong><span>REPLICA</span></strong><span>.</span></p></li><li><p><span>Set the </span><strong><span>Number of tasks</span></strong><span> to </span><code>10</code><span>.</span></p></li><li><p><span>Leave the </span><strong><span>Minimum</span></strong><span> and </span><strong><span>Maximum</span></strong><span> percent as is.</span></p></li><li><p><span>Leave </span><strong><span>Deployment type</span></strong><span> as </span><strong><span>Rolling update</span></strong><span>.</span></p></li><li><p><span>Leave </span><strong><span>Placement Templates</span></strong><span> as </span><strong><span>AZ Balanced Spread</span></strong><span>.</span></p></li><li><p><span>Choose </span><strong><span>Next step</span></strong><span>.  </span></p></li><li><p><span>Scroll down, and uncheck </span><strong><span>Enable service discovery integration</span></strong><span>.  </span></p></li><li><p><span>Health Check Grace Period should show </span><code>requires a load balancer</code></p></li><li><p><span>Load Balancing should be set to </span><strong><span>None</span></strong><span>.</span></p></li><li><p><span>Choose </span><strong><span>Next step</span></strong><span>.</span></p></li><li><p><span>Under </span><strong><span>Service Auto Scaling</span></strong><span> leave </span><strong><span>Do not adjust the service’s desired count</span></strong><span> checked.  Choose </span><strong><span>Next step</span></strong><span>.</span></p><p><span>💁‍♂ We will edit this later when we have a role created that will allow our ECS service to communicate with Cloudwatch for autoscaling functionality.  For now selecting </span><strong><span>"do not adjust the service’s desired count"</span></strong><span> will allow us to launch our 10 containers. It will attempt to maintain them. I.e if you manually stop 3 of them it will launch 3 more to get back to 10.  </span></p></li><li><p><span>You will see a summary.  Choose </span><strong><span>Create Service</span></strong><span>.  </span></p></li><li><p><span>Choose </span><strong><span>View Service</span></strong><span>.  Use the refresh icon and you should see all </span><strong><span>10</span></strong><span> tasks are running.</span></p><p><span>Now that we have 10 new tasks running.  The security group you edited earlier will </span><em><span>still work</span></em><span>.  Try one of the tasks by clicking on one of the blue hyperlinks under the </span><strong><span>Task</span></strong><span> tab.  Expand </span><strong><span>service-api</span></strong><span> under </span><strong><span>Name</span></strong><span>.  Click on the IP:Port under </span><strong><span>External Link</span></strong><span>.  You should again see:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">hello this is the root of the <span class="cm-builtin">service</span> api</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p><span>Let's go back to see our tasks.  Choose </span><strong><span>Clusters</span></strong><span> at the left and select </span><strong><span>fancy-cluster &gt;</span></strong><span>.  Then choose the  </span><strong><span>Tasks</span></strong><span> tab.  </span></p></li><li><p><span>Select any </span><strong><span>5</span></strong><span> tasks and choose </span><strong><span>Stop</span></strong><span> and then confirm by selecting </span><strong><span>Stop</span></strong><span> again.  Refresh until you see it has gone back up to a count of </span><strong><span>10</span></strong><span>.  </span></p></li></ol><p><span>Your students seem to like this </span><code>ECS service</code><span> feature verses manually starting and stopping tasks.  </span></p><p><span>Ok, now you need to show your students how to get to the tasks via a single URL without having to specify ports.  Running it on port 80.</span></p><p><span>Time to introduce the load balancing stuff.</span></p><h3><a name="step-4---demo-how-to-set-up-container-load-balancing" class="md-header-anchor"></a><span>Step 4 - Demo how to set up container load balancing</span></h3><p><span>📓 </span><strong><span>Load balancing settings can </span><u><span>only</span></u><span> be set on service creation. Which means that you can't just update the one we have from the console and add an ALB. You need to create a new service first and then add load balancing after.</span></strong></p><p><span>So what you are going to do now is demonstrate creating an </span><strong><span>ALB placeholder</span></strong><span> and an </span><strong><span>IAM role</span></strong><span> that allows your </span><strong><span>ECS Service</span></strong><span> to manage your tasks for you.</span></p><p><span>The reason I say </span><em><span>placeholder</span></em><span> is because many of the settings that the ALB requires to work with an ECS service don't even exist yet.  You are going to demo creating a new ECS Service in a sec.</span></p><p><span>In your demo, you will need to essentially fill in some blanks </span><em><span>just to get through the ALB creation</span></em><span> in the console. Then you can pass this </span><strong><span>bare bones ALB</span></strong><span> over to the </span><code>ECS service</code><span> to manage.</span></p><p><span>Once we do that and your ECS Service is in charge of this bare bones ALB.  You can then (and only then) go into the ALB settings and configure exactly how you want it to work with the target groups and paths.</span></p><p><span>You make a start on your demo for creating a placeholder ALB:</span></p><ol start=""><li><p><span>Choose </span><strong><span>Services</span></strong><span> and choose </span><strong><span>EC2</span></strong><span>.  Choose </span><strong><span>Load Balancers</span></strong><span>.</span></p></li><li><p><span>Choose </span><strong><span>Create Load Balancer</span></strong><span>.  Under </span><strong><span>Application Load Balancer</span></strong><span> choose </span><strong><span>Create</span></strong><span>.</span></p></li><li><p><span>Name it </span><code>fancy-alb</code><span>. </span></p></li><li><p><span>The </span><strong><span>Scheme</span></strong><span> will remain </span><strong><span>internet-facing</span></strong><span> and the </span><strong><span>IP address type</span></strong><span> is </span><strong><span>ipv4</span></strong><span>.</span></p></li><li><p><span>Leave the protocol as </span><strong><span>HTTP</span></strong><span> and </span><strong><span>Load Balancer Port</span></strong><span> as </span><strong><span>80</span></strong><span>.</span></p></li><li><p><span>For </span><strong><span>VPC</span></strong><span> choose the VPC that </span><strong><span>does not</span></strong><span> have the name </span><strong><span>C9</span></strong><span> or </span><strong><span>default</span></strong><span>.   </span><em><span>It should have also been output from the </span><code>lab-helper</code><span> script that was run</span></em><span>.</span></p></li><li><p><span>Select both </span><strong><span>Availability Zones</span></strong><span> such as </span><strong><span>us-west-2a</span></strong><span> and </span><strong><span>us-west-2b</span></strong><span>.  </span><em><span>The subnets will match what was output from the </span><code>lab-helper</code><span> script</span></em><span>. </span></p><p>⚠️<span> </span><strong><span>Also make note of the VPC ID, both SubnetIDs, along with the Security Group Id earlier, for this load balancer.  </span></strong><span>You will need them later. </span>💁‍♂<span> </span><em><span>These values were output from the </span><code>lab-helper</code><span> script</span></em><span>.</span></p></li><li><p><span>Choose </span><strong><span>Next: Configure Security Settings</span></strong><span>.  </span><u><span>Ignore the warnings</span></u><span> and choose </span><strong><span>Next: Configure Security Groups</span></strong><span>.</span></p></li><li><p><span>Under </span><strong><span>Assign a security group</span></strong><span> choose </span><strong><span>Create a new security group</span></strong><span> and name it </span><code>fancy-alb-sg</code><span> under the </span><strong><span>Security group name</span></strong><span> and </span><strong><span>Description</span></strong><span>.</span></p></li><li><p><span>Leave the </span><strong><span>Rule</span></strong><span> as is, so all traffic can reach our ALB from port </span><strong><span>80</span></strong><span>.</span></p></li><li><p><span>Choose </span><strong><span>Next: Configure Routing</span></strong><span>.  </span></p></li><li><p><span>Under </span><strong><span>Target group</span></strong><span> leave this as </span><strong><span>New target group</span></strong><span>.</span></p></li><li><p><strong><span>Name</span></strong><span> it </span><code>service-target-group</code><span>.  </span></p></li><li><p><span>Leave the </span><strong><span>Target type</span></strong><span> as </span><strong><span>Instance</span></strong><span>.</span></p></li><li><p><span>Leave the Protocol as </span><strong><span>HTTP</span></strong><span> and the </span><strong><span>Port</span></strong><span> as </span><strong><span>80</span></strong><span>.</span></p></li><li><p><span>Also leave the </span><strong><span>Health Check</span></strong><span> as </span><strong><span>HTTP</span></strong><span> and </span><strong><span>Path</span></strong><span> /</span></p><p><span>As we are not really defining a real target yet (we do that later).  We do need to provide something for our wizard.  So when someone hits </span><code>/</code><span> (the root path) it can at least have 1 target.  Which is the absolute minimum for an ALB console wizard. </span>💁‍♂<span> </span><em><span>a bit hacky I know but go with me on this.</span></em></p><p><span>As you are going through these steps.  One of your students asks you "Won't the </span><code>/</code><span> at port 80 mean it will fail a health check as nothing is going to be there if we use ephemeral ports?"</span></p><p><span>You remind her that most of these values are just a placeholders and we will add the real values after we hand over control of the ALB to the ECS service, where we will let ECS handle things like task health checking.</span></p></li><li><p><span>Choose </span><strong><span>Next: Register Targets</span></strong><span>.  </span></p><p><u><span>Don't select anything here</span></u><span>.  You explain to your students that you are are not trying to balance load </span><em><span>across host EC2s</span></em><span> and that the ECS service will handle this for us. So leave you bare bones ALB with </span><strong><span>no targets</span></strong><span> for now.</span></p></li><li><p><span>Choose </span><strong><span>Next: Review</span></strong><span>.  Choose </span><strong><span>Create</span></strong><span>.  Choose </span><strong><span>Close</span></strong><span>. </span></p><p><span> </span>📓<span> There is no point in testing it just yet, as it points to nowhere and is not complete.</span></p><p><span>You next need to set up a brand new </span><code>ECS service</code><span> and pass it our bare bones ALB.  Then all those placeholder things you left out above can be modified.  </span><u><span>As mentioned before we can't update our existing fancy cluster with a load balancer</span></u><span>, we need to create a new cluster first.</span></p><p><span>Hmmm 🤔  what will you call this cluster?</span></p><p><span>You put it to a vote.</span></p><p><span>Consensus is ...you guessed it...</span><code>fancy-cluster-2</code><span>.</span></p><p><span>You are going to leave the old fancy-cluster's task running for now. Your new cluster will like before use    4 brand new machines.  </span></p><p><span>Switch back to the </span><strong><span>Cloud9</span></strong><span> tab.</span></p></li><li><p><span>Run the following in </span><strong><span>Cloud9</span></strong><span> to create </span><code>fancy-cluster-2</code></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> ecs-cli configure <span class="cm-attribute">--cluster</span> fancy-cluster-2 <span class="cm-attribute">--default-launch-type</span> EC2 <span class="cm-attribute">--config-name</span> fancy-cluster-2 <span class="cm-attribute">--region</span> us-west-2</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span> You should see:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> INFO[0000] Saved ECS CLI cluster configuration fancy-cluster-2.</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span> Use the VPC, security group, and subnets you jotted down earlier as</span><code>&lt;FMI_1&gt;</code><span>, </span><code>&lt;FMI_2&gt;</code><span> and </span><code>&lt;FMI_3&gt;</code><span> respectfully.</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> ecs-cli up <span class="cm-attribute">--keypair</span> vockey <span class="cm-attribute">--capability-iam</span> <span class="cm-attribute">--size</span> <span class="cm-number">4</span> <span class="cm-attribute">--instance-type</span> m4.large <span class="cm-attribute">--cluster-config</span> fancy-cluster-2 <span class="cm-attribute">--region</span> us-west-2 <span class="cm-attribute">--vpc</span> &lt;FMI_1&gt; <span class="cm-attribute">--security-group</span> &lt;FMI_2&gt; <span class="cm-attribute">--subnets</span> &lt;FMI_3&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p><span> As an example: </span>💁‍♂<span> </span><em><span>Yours will be different.</span></em></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> ecs-cli up <span class="cm-attribute">--keypair</span> vockey <span class="cm-attribute">--capability-iam</span> <span class="cm-attribute">--size</span> <span class="cm-number">4</span> <span class="cm-attribute">--instance-type</span> m4.large <span class="cm-attribute">--cluster-config</span> fancy-cluster-2 <span class="cm-attribute">--region</span> us-west-2 <span class="cm-attribute">--vpc</span> vpc-04db469e14fcba11f <span class="cm-attribute">--security-group</span> sg-0bb60cfa247e8a894 <span class="cm-attribute">--subnets</span> subnet-07fa80fc8f32c315f,subnet-041730a5c01565ed5 </span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><span> </span>📓<span> You advise your students that you are providing the VPC info above because you don't want your new 4 EC2s to be created in a brand new VPC which would be the default. That would be no good, as the ALB you just created wouldn't be able to talk to the machines on those subnets.  For simplicity you are passing a security group that you already set up to allow for access on all ports, rather than have ecs-cli create a new one which would just allow port 80 by default.</span></p><p><span> This will give you the following output (a bit like before): </span>⏰<span> </span><em><span>This takes about 4 minutes</span></em><span>:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> INFO[0000] Using recommended Amazon Linux <span class="cm-number">2</span> AMI with ECS Agent <span class="cm-number">1</span>.35.0 and Docker version <span class="cm-number">18</span>.09.9-ce </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> INFO[0000] Created cluster &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-def">cluster</span><span class="cm-operator">=</span>fancy-cluster-2 <span class="cm-def">region</span><span class="cm-operator">=</span>us-west-2</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> INFO[0000] Waiting <span class="cm-keyword">for</span> your cluster resources to be created... </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> INFO[0000] Cloudformation stack status &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-def">stackStatus</span><span class="cm-operator">=</span>CREATE_IN_PROGRESS</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> INFO[0060] Cloudformation stack status &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-def">stackStatus</span><span class="cm-operator">=</span>CREATE_IN_PROGRESS</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> INFO[0121] Cloudformation stack status &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-def">stackStatus</span><span class="cm-operator">=</span>CREATE_IN_PROGRESS</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> Cluster creation succeeded.</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 276px;"></div><div class="CodeMirror-gutters" style="display: none; height: 276px;"></div></div></div></pre><p><span> </span>💁‍♂<span> Check it out in the EC2 console if you want. You will see it has created 4 new EC2s just like before in the </span><strong><span>ECS Instances</span></strong><span> tab.  </span></p><p><span> It's time to demo creating an </span><strong><span>ECS Service</span></strong><span> but this time you are going to pass in that bare bones ALB you prepared earlier.</span></p></li><li><p><span>Switch back to the </span><strong><span>Load Balancers</span></strong><span> tab.  Choose </span><strong><span>Services</span></strong><span> and choose </span><strong><span>ECS</span></strong><span>.  </span></p></li><li><p><span>Under </span><strong><span>Clusters</span></strong><span> (refresh the page) choose the </span><strong><span>fancy-cluster-2 &gt;</span></strong><span>.</span></p></li><li><p><span>Choose the </span><strong><span>Services</span></strong><span> tab and choose </span><strong><span>Create</span></strong><span>.</span></p></li><li><p><span>Choose </span><strong><span>EC2</span></strong><span> under </span><strong><span>Launch type</span></strong><span>.  </span></p></li><li><p><span>Don't change anything under </span><strong><span>Task Definition</span></strong><span>.  </span><strong><span>Cluster</span></strong><span> should also show </span><code>fancy-cluster-2</code><span>.</span></p></li><li><p><span>Under </span><strong><span>Service name</span></strong><span>.  Name it </span><code>balanced-service</code><span>.</span></p></li><li><p><span>Leave </span><strong><span>Service type</span></strong><span> as </span><strong><span>REPLICA</span></strong><span>.</span></p></li><li><p><span>Under </span><strong><span>Number of tasks</span></strong><span> enter in </span><code>20</code><span>.  </span></p></li><li><p><span>Leave the </span><strong><span>Minimum</span></strong><span> and </span><strong><span>Maximum</span></strong><span> percent alone.</span></p></li><li><p><span>Leave </span><strong><span>Deployment type</span></strong><span> as </span><strong><span>Rolling update</span></strong><span>.</span></p></li><li><p><span>Under </span><strong><span>Placement Templates</span></strong><span> leave it as </span><strong><span>AZ Balanced Spread</span></strong><span>.</span></p></li><li><p><span>Choose </span><strong><span>Next step</span></strong><span>.</span></p></li><li><p><span>Scroll to the Load balancing section, and choose </span><strong><span>Application Load Balancer</span></strong><span> under </span><strong><span>Load balancer type</span></strong><span>.  It should pre-populate the Load Balancer name below it with </span><code>fancy-alb</code><span>.  </span></p></li><li><p><span>You will notice their section above for </span><strong><span>Health check grace period</span></strong><span> is now showing </span><code>0</code><span> leave that as is.</span></p></li><li><p><span>Scroll back down to Service IAM role under Load Balancing.</span></p></li><li><p><span>Under </span><strong><span>Service IAM role</span></strong><span> choose </span><strong><span>AWSServiceRoleForECS</span></strong><span>.</span></p><p>💁‍♂<span> To save time we created an AWS Service IAM role that should be available as </span><code>AWSServiceRoleForECS</code><span>.  </span></p><p><span>You tell your students you prepared this earlier to save time. </span>💁‍♂<span> </span><em><span>It basically allows for the basics of autoscaling and working with ECS.</span></em><span>  </span></p><p><span>You bring it onto the screen just so they know what you did:</span></p><h6><a name="awsserviceroleforecs" class="md-header-anchor"></a><strong><span>AWSServiceRoleForECS</span></strong></h6><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"Version"</span>: <span class="cm-string">"2012-10-17"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"Statement"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Sid"</span>: <span class="cm-string">"ECSTaskManagement"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Effect"</span>: <span class="cm-string">"Allow"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Action"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"ec2:AttachNetworkInterface"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"ec2:CreateNetworkInterface"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"ec2:CreateNetworkInterfacePermission"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"ec2:DeleteNetworkInterface"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"ec2:DeleteNetworkInterfacePermission"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"ec2:Describe*"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"ec2:DetachNetworkInterface"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"elasticloadbalancing:DeregisterInstancesFromLoadBalancer"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"elasticloadbalancing:DeregisterTargets"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"elasticloadbalancing:Describe*"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"elasticloadbalancing:RegisterInstancesWithLoadBalancer"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"elasticloadbalancing:RegisterTargets"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"route53:ChangeResourceRecordSets"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"route53:CreateHealthCheck"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"route53:DeleteHealthCheck"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"route53:Get*"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"route53:List*"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"route53:UpdateHealthCheck"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"servicediscovery:DeregisterInstance"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"servicediscovery:Get*"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"servicediscovery:List*"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"servicediscovery:RegisterInstance"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"servicediscovery:UpdateInstanceCustomHealthStatus"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Resource"</span>: <span class="cm-string">"*"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Sid"</span>: <span class="cm-string">"AutoScaling"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Effect"</span>: <span class="cm-string">"Allow"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Action"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"autoscaling:Describe*"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Resource"</span>: <span class="cm-string">"*"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Sid"</span>: <span class="cm-string">"AutoScalingManagement"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Effect"</span>: <span class="cm-string">"Allow"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Action"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"autoscaling:DeletePolicy"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"autoscaling:PutScalingPolicy"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"autoscaling:SetInstanceProtection"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"autoscaling:UpdateAutoScalingGroup"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Resource"</span>: <span class="cm-string">"*"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Condition"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Null"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"autoscaling:ResourceTag/AmazonECSManaged"</span>: <span class="cm-string">"false"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Sid"</span>: <span class="cm-string">"AutoScalingPlanManagement"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Effect"</span>: <span class="cm-string">"Allow"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Action"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"autoscaling-plans:CreateScalingPlan"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"autoscaling-plans:DeleteScalingPlan"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"autoscaling-plans:DescribeScalingPlans"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Resource"</span>: <span class="cm-string">"*"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Sid"</span>: <span class="cm-string">"CWAlarmManagement"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Effect"</span>: <span class="cm-string">"Allow"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Action"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"cloudwatch:DeleteAlarms"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"cloudwatch:DescribeAlarms"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"cloudwatch:PutMetricAlarm"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Resource"</span>: <span class="cm-string">"arn:aws:cloudwatch:*:*:alarm:*"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Sid"</span>: <span class="cm-string">"ECSTagging"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Effect"</span>: <span class="cm-string">"Allow"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Action"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"ec2:CreateTags"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Resource"</span>: <span class="cm-string">"arn:aws:ec2:*:*:network-interface/*"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Sid"</span>: <span class="cm-string">"CWLogGroupManagement"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Effect"</span>: <span class="cm-string">"Allow"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Action"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"logs:CreateLogGroup"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"logs:DescribeLogGroups"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"logs:PutRetentionPolicy"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Resource"</span>: <span class="cm-string">"arn:aws:logs:*:*:log-group:/aws/ecs/*"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Sid"</span>: <span class="cm-string">"CWLogStreamManagement"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Effect"</span>: <span class="cm-string">"Allow"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Action"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"logs:CreateLogStream"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"logs:DescribeLogStreams"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"logs:PutLogEvents"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"Resource"</span>: <span class="cm-string">"arn:aws:logs:*:*:log-group:/aws/ecs/*:log-stream:*"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 2461px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2461px;"></div></div></div></pre><p><span>They seem happy with that policy so you move on with your demo.</span></p></li><li><p><span>For </span><strong><span>Container name: port</span></strong><span> it should have pre-populated </span><code>service-api:0:3000</code><span>.  Choose </span><strong><span>Add to load balancer</span></strong><span>.  </span></p></li><li><p><span>Change the </span><strong><span>Target group name</span></strong><span> dropdown to </span><code>service-target-group</code><span>.  This will automatically set </span><strong><span>Production listener port</span></strong><span> to 80 and </span><strong><span>Production listener protocol</span></strong><span> to </span><code>http</code></p></li><li><p><strong><span>Target group protocol</span></strong><span> should show as </span><code>http</code><span> and </span><strong><span>instance</span></strong><span> should be showing as the </span><strong><span>target type</span></strong><span>.</span></p></li><li><p><span>The path pattern as </span><code>/</code><span> with the evaluation order set to </span><code>default</code><span> .  Also the the health check will be </span><code>/</code></p></li><li><p><span>Scroll down past </span><strong><span>App Mesh</span></strong><span> to </span><strong><span>Service Discovery</span></strong><span>, and uncheck </span><strong><span>Enable service discovery integration</span></strong><span>.</span></p></li><li><p><span>Choose </span><strong><span>Next step</span></strong><span>.  </span></p></li><li><p><span>Leave </span><strong><span>Service Auto Scaling</span></strong><span> as </span><strong><span>Do no adjust the service's desired count</span></strong><span>.  Choose </span><strong><span>Next step</span></strong><span>.  </span></p></li><li><p><span>Click </span><strong><span>Create Service</span></strong><span>.  </span></p></li><li><p><span>Click </span><strong><span>View Service</span></strong><span>.  </span></p><p><span>If you </span><u><span>refresh it a bi</span></u><span>t, it will look like it's all working.  But its not!  Do you notice something?  You only have </span><code>16</code><span> and not the desired </span><code>20</code><span>!  This is because there is not enough room.  Go to the </span><strong><span>Events</span></strong><span> tab and see what it's telling you.</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">service</span> balanced-service was unable to place a task because no container instance met all of its requirements. The closest matching container-instance be4e11c7-cceb-491c-bf01-a626603e016c has insufficient CPU units available. For more information, see the Troubleshooting section.</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><span>Smart huh?  It knows how much space it has across the machines.</span></p><p><span>The reason your tasks are passing the health checks is because of the above settings.  Each task is reporting that the </span><u><span>internal</span></u><span> localhost port 3000 at </span><code>/</code><span> is healthy.  The ALB health check is not in play or really relevant anymore.  </span></p><p><span>You show this your students and tell them that the ECS Service has "got this".</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">service</span> [balanced-service](https://us-west-2.console.aws.amazon.com/ecs/home<span class="cm-def">?region</span><span class="cm-operator">=</span>us-west-2<span class="cm-comment">#/clusters/fancy-cluster-2/services/balanced-service) (instance i-00e02ce896897e7b4) (port 32770) is unhealthy in target-group [service-target-group](https://us-west-2.console.aws.amazon.com/ec2/v2/home?region=us-west-2#TargetGroups:search=arn:aws:elasticloadbalancing:us-west-2:771152176606:targetgroup/service-target-group/1ebc75fa25ff29a4) due to (reason Request timed out)</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><p><span>They all seem happy, so far. So it's time to configure that placeholder ALB with path based routing.</span></p></li><li><p><span>Choose </span><strong><span>Services</span></strong><span> and </span><strong><span>EC2</span></strong><span>.  Choose </span><strong><span>Load Balancers</span></strong><span>.   </span></p></li><li><p><span>Select </span><code>fancy-alb</code><span>.</span></p></li><li><p><span>Under the </span><strong><span>Listeners</span></strong><span> tab choose </span><strong><span>View/edit rules</span></strong><span>.  </span></p></li><li><p><span>Choose the </span><strong><span>Pencil</span></strong><span> icon at the top of the page to start editing.  </span></p></li><li><p><span>Click the other </span><strong><span>Pencil</span></strong><span> icon on left (next to the word </span><strong><span>last</span></strong><span>).  Then click the </span><strong><span>Pencil</span></strong><span> icon on the right next to the words </span><strong><span>Forward to...</span></strong><span>.</span></p></li><li><p><span>Click the </span><strong><span>Trash Bin</span></strong><span> Icon to the right of </span><strong><span>Forward to...</span></strong><span>.  </span></p></li><li><p><span>Choose </span><strong><span>Add action</span></strong><span> and </span><strong><span>Return fixed response...</span></strong><span>.</span></p></li><li><p><span>Change the response code to </span><code>200</code><span>.</span></p></li><li><p><span>Leave the </span><strong><span>Content-Type</span></strong><span> as </span><code>text/plain</code><span>.  </span></p></li><li><p><span>Paste the following into the </span><strong><span>Response body</span></strong><span>:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> Please choose an API (service or price)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p><span>Choose the </span><strong><span>Checkmark</span></strong><span> at the bottom.  </span></p></li><li><p><span>Choose </span><strong><span>Update</span></strong><span> at the top right. </span></p><p><span> Next you are going to demonstrate </span><u><span>path based routing</span></u><span> and ensure </span><code>/service</code><span> points to the right place.</span></p><p><span> ⚠️  As a prerequisite for path based routing we need to enable our apps to handle requests at </span><code>/service/get-service-area</code><span> and </span><code>/price/get-prices</code><span>.  Not just at </span><code>/get-service-area</code><span> and </span><code>/get-prices</code><span>.  Path based routing in ECS via load balancing is slightly different than CloudFront where there is less of a direct mapping.  </span>💁‍♂<span> </span><em><span>Luckily our app code is capable of handing requests at both already (see the node code of the app if you are curious).</span></em><span>  </span></p></li></ol><h4><a name="lets-create-some-path-based-routing-on-the-load-balancer" class="md-header-anchor"></a><span>Let's create some path based routing on the load balancer</span></h4><p><span>You now have a </span><code>/</code><span> returning a static response. You need more than that. So you demo setting up more paths.</span></p><p><span>One for </span><code>service</code><span> that tells them that they need to pass a function name, and one for </span><code>service/get-service-area</code><span> (we will use </span><code>service/*</code><span>) which will return data in JSON format.</span></p><p><span>This is what we </span><u><span>want</span></u><span>, but don't yet have:</span></p><figure><table><thead><tr><th><span>Endpoint example</span></th><th><span>Action</span></th></tr></thead><tbody><tr><td><a href="http://34.210.68.169:32772/" target="_blank" class="url">http://34.210.68.169:32772/</a></td><td><span>Blocked by host security groups</span></td></tr><tr><td><a href="http://fancy-alb-259563215.us-west-2.elb.amazonaws.com/get-service-area" target="_blank" class="url">http://fancy-alb-259563215.us-west-2.elb.amazonaws.com/get-service-area</a></td><td><span>Our text saying "Please choose an API (service or price)"</span></td></tr><tr><td><a href="http://fancy-alb-259563215.us-west-2.elb.amazonaws.com/service/get-service-area" target="_blank" class="url">http://fancy-alb-259563215.us-west-2.elb.amazonaws.com/service/get-service-area</a></td><td><span>Returns JSON data</span></td></tr><tr><td><a href="http://fancy-alb-259563215.us-west-2.elb.amazonaws.com/service" target="_blank" class="url">http://fancy-alb-259563215.us-west-2.elb.amazonaws.com/service</a></td><td><span>Our text saying "Choose a method of service"</span></td></tr></tbody></table></figure><p><em><a href="http://34.210.68.169:32772/" target="_blank" class="url">http://34.210.68.169:32772/</a><span> and </span><a href="http://fancy-alb-259563215.us-west-2.elb.amazonaws.com/get-service-area" target="_blank" class="url">http://fancy-alb-259563215.us-west-2.elb.amazonaws.com/get-service-area</a><span> </span><strong><span>are just examples BTW</span></strong><span>.</span></em></p><p><span>Later we can expand upon this for our price API and thus SHARE the ALB ;) saving money and making better use of our resources.</span></p><p><span>You advise them that you don't need to change the ALB health check that is not used, since we have an ECS service in charge of things.</span></p><p><span>If the task is not working ECS will replace it regardless of the ALB's health check. Its ok to always pass the ALB get health check and rely solely on the ECS service system checking container health.</span></p><p><span>As you are already in the Rules section of you ALB.</span></p><ol start="57"><li><p><span>Choose the </span><strong><span>Plus</span></strong><span> icon at the top of the page (</span><em><span>left of the pencil icon</span></em><span>).</span></p></li><li><p><span>Choose the </span><strong><span>Insert Rule</span></strong><span> hyperlink.  Then </span><strong><span>Add condition</span></strong><span> under </span><strong><span>IF (all match)</span></strong><span> and choose </span><strong><span>Path...</span></strong><span>.  </span></p></li><li><p><span>Type in </span><code>/service/*</code><span> and choose the </span><strong><span>Checkmark</span></strong><span> icon.  </span></p></li><li><p><span>At the right under </span><strong><span>THEN</span></strong><span> choose </span><strong><span>Add action</span></strong><span> and choose </span><strong><span>Forward to...</span></strong><span>.  </span></p></li><li><p><span>Select the </span><code>service-target-group</code><span>.  Choose the </span><strong><span>Checkmark</span></strong><span> icon.  </span></p></li><li><p><span>Choose </span><strong><span>Save</span></strong><span> at the top right.  </span></p></li><li><p><u><span>One more</span></u><span>. Click the plus icon. </span>💁‍♂<span> </span><em><span>You might need to refresh the page to enable it</span></em></p></li><li><p><span>Choose the </span><strong><span>Insert Rule</span></strong><span> hyperlink.  Then </span><strong><span>Add condition</span></strong><span> under </span><strong><span>IF (all match)</span></strong><span> and choose </span><strong><span>Path...</span></strong><span>.  </span></p></li><li><p><span>Type in </span><code>/service</code><span> and choose the </span><strong><span>Checkmark</span></strong><span> icon.   (Note the lack of </span><code>/</code><span> and </span><code>*</code><span> here)</span></p></li><li><p><span>Choose </span><strong><span>Add action</span></strong><span> under </span><strong><span>THEN</span></strong><span> and </span><strong><span>Return fixed response...</span></strong><span>.</span></p></li><li><p><span>Change the response code to </span><code>200</code><span>.</span></p></li><li><p><span>Leave the </span><strong><span>Content-Type</span></strong><span> as </span><code>text/plain</code><span>.   </span></p></li><li><p><span>Paste the following into the </span><strong><span>Response body</span></strong><span>:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Choose a method of <span class="cm-builtin">service</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p><span>Select the checkmark.  Then choose </span><strong><span>Save</span></strong><span> at the top right.  </span></p></li><li><p><span>Choose the </span><strong><span>&lt;</span></strong><span> icon (top left of the page) to go back to Load Balancers.  Choose the </span><strong><span>Description</span></strong><span> tab and grab the ALB DNS name.  It will look like the following: </span><code>fancy-alb-396921161.us-west-2.elb.amazonaws.com</code><span> if you paste it into your browser.</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#fancy-alb-396921161.us-west-2.elb.amazonaws.com</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Please choose an API (service or price)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>Now test it by browsing to </span><code>/service</code><span> using your ALB DNS name.  You should see the following:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#fancy-alb-396921161.us-west-2.elb.amazonaws.com/service</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Choose a method of <span class="cm-builtin">service</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li><li><p><span>Now try hitting the data endpoint </span><code>/service/get-service-area</code><span>  to make sure you get the hard coded app data of </span><strong><span>vegas</span></strong><span> and </span><strong><span>chicago</span></strong><span>.</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#fancy-alb-396921161.us-west-2.elb.amazonaws.com/service/get-service-area</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"cities_arr"</span>: [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"vegas"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"chicago"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 184px;"></div><div class="CodeMirror-gutters" style="display: none; height: 184px;"></div></div></div></pre></li></ol><p><strong><span>Awesome</span></strong><span>!  </span></p><ol start="73"><li><span>Under </span><strong><span>LOAD BALANCING</span></strong><span> choose </span><strong><span>Target Groups</span></strong><span>.  Then choose </span><strong><span>Targets</span></strong><span>.  </span></li></ol><p><img src="./Screen Shot 2019-11-26 at 10.28.38 AM.png" referrerpolicy="no-referrer" alt="Screen Shot 2019-11-26 at 10.28.38 AM"></p><p>&nbsp;</p><p><span>You have now shown them it all working.  Congratulations!  Path based routing is up and running.</span></p><p><span>The URI above is balanced across 4 machines in 2 AZ's across a one of 16 machines. #win</span></p><h3><a name="step-5---add-autoscaling" class="md-header-anchor"></a><span>Step 5 - Add Autoscaling</span></h3><p><span>They already know, as you showed them, that if you killed off a task a new one would spawn until you have 16 again. However you clarify to them that this is not really true performance metric based autoscaling that scales up or down based on load. </span></p><p><span>You are going to demo that now.</span></p><p><span>You will need to show them how to adjust the settings in the ECS service to enable autoscaling.</span></p><ol start=""><li><span>Choose </span><strong><span>Services</span></strong><span> and </span><strong><span>ECS</span></strong><span>.  Choose </span><strong><span>Clusters</span></strong><span> and select the </span><strong><span>fancy-cluster-2 &gt;</span></strong><span>.</span></li><li><span>Click the </span><strong><span>balanced-service</span></strong><span> hyperlink.</span></li><li><span>Choose </span><strong><span>Update</span></strong><span> at the top right.  </span></li><li><span>The </span><strong><span>Task Definition</span></strong><span> should have populated to </span><strong><span>fancy-project</span></strong><span>.</span></li><li><strong><span>Launch type</span></strong><span> is also </span><strong><span>EC2</span></strong><span>.  The </span><strong><span>Cluster</span></strong><span> is also populated to </span><strong><span>fancy-cluster-2</span></strong><span>.</span></li><li><span>Ensure </span><strong><span>Force new deployment</span></strong><span> is </span><strong><span>unchecked</span></strong><span>, we don't need to respawn our machines, autoscaling will adjust the ones we have once we set it up correctly.</span></li><li><strong><span>Service name</span></strong><span> should have also populated to </span><strong><span>balanced-service</span></strong><span>.</span></li><li><strong><span>Service type</span></strong><span> is also set to </span><strong><span>REPLICA</span></strong><span>.  </span></li><li><span>Set </span><strong><span>Number of tasks</span></strong><span> to </span><code>10</code><span>.  (This gets overridden in a sec)</span></li><li><span>Leave the </span><strong><span>Minimum</span></strong><span> and </span><strong><span>Maximum</span></strong><span> percent as is.</span></li><li><span>Choose </span><strong><span>Next step</span></strong><span>.  Leave </span><strong><span>Health check grace period</span></strong><span> as </span><code>0</code><span>.</span></li><li><span>Choose </span><strong><span>Next step</span></strong><span>.  </span></li><li><span>For </span><strong><span>Service Auto Scaling</span></strong><span> choose </span><strong><span>Configure Service Auto Scaling to adjust your service's desired count</span></strong><span>.</span></li><li><span>Set </span><strong><span>Minimum number of tasks</span></strong><span> to </span><code>2</code><span>. </span>💁‍♂<span> We need High Availability so 2 has to be the minimum.</span></li><li><span>Set </span><strong><span>Desired number of tasks</span></strong><span> to </span><code>10</code><span>. </span>💁‍♂<span> A reasonable starting point.</span></li><li><span>Set </span><strong><span>Maximum number of tasks</span></strong><span> to </span><code>16</code><span>. </span>💁‍♂<span> As we know that is the max that will fit already ;)</span></li><li><span>Leave </span><strong><span>IAM role for Service Auto Scaling</span></strong><span> as </span><strong><span>Create new role</span></strong><span>.</span></li><li><span>Choose </span><strong><span>Add scaling policy</span></strong><span>.  This will open a side bar window.</span></li><li><span>Leave </span><strong><span>Scaling policy type</span></strong><span> as </span><strong><span>Target tracking</span></strong><span>.</span></li><li><span>Set the </span><strong><span>Policy name</span></strong><span> to </span><code>fancy-tracking-policy</code><span>.</span></li><li><span>Leave </span><strong><span>ECS service metric</span></strong><span> as </span><strong><span>ECSServiceAverageCPUUtilization</span></strong><span>.  </span></li><li><span>Set the </span><strong><span>Target value</span></strong><span> to </span><code>70</code><span>.  Change both the </span><strong><span>Scale-out cooldown period</span></strong><span> and </span><strong><span>Scale-in cooldown period</span></strong><span> to </span><code>100</code><span>.  </span></li><li><span>Make sure </span><strong><span>Disable scale-in</span></strong><span> remains </span><strong><span>unchecked</span></strong><span>.  </span></li><li><span>Choose </span><strong><span>Save</span></strong><span>.  Choose </span><strong><span>Next step</span></strong><span>.  Choose </span><strong><span>Update Service</span></strong><span>.  It will eventually show the following:</span></li></ol><p><img src="./Screen Shot 2019-12-30 at 11.40.54 AM.png" referrerpolicy="no-referrer" alt="Screen Shot 2019-12-30 at 11.40.54 AM"></p><ol start="25"><li><p><span>Choose </span><strong><span>View Service</span></strong><span> at the bottom right.  </span></p></li><li><p><span>Choose the </span><strong><span>Events</span></strong><span> tab to see the following:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Message: Successfully <span class="cm-keyword">set</span> desired count to <span class="cm-number">16</span>. Waiting <span class="cm-keyword">for</span> change to be fulfilled by ecs. Cause: maximum capacity was <span class="cm-keyword">set</span> to <span class="cm-number">16</span>.</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>This is because it is trying to go from 16 to a target of 10.</span></p><p>⏰<span> This can take a while  </span></p><p><span>As there is not much power required for no traffic, you may notice that the desired count goes to 9 then to 8 etc.  Eventually it will go to 2.  Instead of waiting around for </span><u><span>ages</span></u><span> to see this system drain and eventually go down to 2 machines, let's do a hack. </span></p><p><span>Kill off all the machines, and let it spin up 10 automatically and start scaling down slowly to 2 from there.</span></p></li><li><p><span>Choose </span><strong><span>Clusters</span></strong><span> and select the </span><strong><span>fancy-cluster-2 &gt;</span></strong><span>.  Choose the </span><strong><span>Tasks</span></strong><span> tab.  Select </span><strong><span>Stop All</span></strong><span>.  Verify by typing </span><code>STOP ALL</code><span> then choose </span><strong><span>Stop all</span></strong><span>.  </span></p><p><span>Your min autoscaling criteria will prevent less than 2 being up, and as you destroyed all the tasks.  It will start off with 10 and work down if it is receiving no traffic:</span></p><p><em><span>Eventually</span></em><span> it will look like this:</span></p></li></ol><p><img src="./Screen Shot 2019-11-26 at 10.51.22 AM.png" referrerpolicy="no-referrer" alt="Screen Shot 2019-11-26 at 10.51.22 AM"></p><p><span>Cool you have shown them task autoscaling, with High Availability. You remind them that it won't allow you to go past 16 tasks across our 4 hosts, as there would be no room for the ECS Service to place them.</span></p><p><em>💁‍♂<span> If you try and kill a task manually it will go back to the last set desired count first before it starts abiding by the low CPU autoscaling rules.</span></em></p><p><strong><span>Awesome</span></strong><span>!  You have an ECS Service that is autoscaling up and down based on CPU of your tasks. You are just showing the tip of the iceberg with regards to what is possible with autoscaling, but still your students seem impressed.</span></p><p><span>One of your students at the back of the room, raises his hand and asks "Can you show us how to use Fargate, please?"</span></p><h3><a name="step-6---fargate" class="md-header-anchor"></a><span>Step 6 - Fargate</span></h3><p><span>You smile widely, as you have been saving the best for last.  </span></p><p><span>You don't need to explain Fargate as they have already watched videos on this, and "get the concept" of not needing to provide hosts for the tasks. They just wanted you to demo-it working.</span></p><p><span>Sinc you already have an IAM role that we can use for Fargate, and as you plan on sharing the load balancer, you actually don;t have that much to do in tis demo!</span></p><p><span>Here are the steps that you show them.</span></p><p><span>Leave </span><strong><span>fancy-cluster-2</span></strong><span> running as we will be </span><strong><span>re-using</span></strong><span> it for Fargate tasks.</span></p><p>💁‍♂<span> </span><em><span>You students seem impressed that it can do that btw.</span></em></p><ol start=""><li><p><span>In </span><strong><span>Cloud9</span></strong><span> open the file </span><code>resources/for_ecs/price-api/ecs-params.yaml</code><span>.</span></p></li><li><p><span>Replace its contents with this:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="yaml" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">version</span><span class="cm-meta">: </span><span class="cm-number">1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">task_definition</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  ecs_network_mode</span><span class="cm-meta">: </span><span class="cm-string">"awsvpc"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  task_execution_role</span><span class="cm-meta">: </span><span class="cm-string">"&lt;FMI_1&gt;"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  task_size</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  cpu_limit</span><span class="cm-meta">: </span><span class="cm-string">".5 vCPU"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  mem_limit</span><span class="cm-meta">: </span><span class="cm-string">"2GB"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">run_params</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  awsvpc_configuration</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  subnets</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp; &nbsp;  - </span><span class="cm-string">"&lt;FMI_2&gt;"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp; &nbsp;  - </span><span class="cm-string">"&lt;FMI_3&gt;"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  security_groups</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp; &nbsp;  - </span><span class="cm-string">"&lt;FMI_4&gt;"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  assign_public_ip</span><span class="cm-meta">: </span>ENABLED</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 345px;"></div><div class="CodeMirror-gutters" style="display: none; height: 345px;"></div></div></div></pre><p><span>📓 Note there is a lot more info in this one than the service one you did before.</span></p><p><span>Edit the </span><code>&lt;FMI_1&gt;</code><span> to the task role like before: You can get the role by using this line</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aws iam get-role <span class="cm-attribute">--role-name</span> fancy-task-role | <span class="cm-builtin">grep</span> Arn</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p>📓<span> Note the addition of </span><code>awsvpc_configuration</code><span> and the </span><strong><span>awsvpc</span></strong><span> </span><u><span>mode</span></u><span>.  You will need to add the </span><strong><span>subnets</span></strong><span> (</span><code>&lt;FMI_2&gt;,&lt;FMI_3&gt;</code><span>) and </span><strong><span>security groups</span></strong><span> (</span><code>&lt;FMI_4&gt;</code><span>) like before.</span></p><p><span>We want our Fargate tasks to share the ALB and thus they (Fargate tasks) must go in the same subnets:</span></p><p><span>Example:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">version: <span class="cm-number">1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">task_definition:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  ecs_network_mode: <span class="cm-string">"awsvpc"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  task_execution_role: <span class="cm-string">"arn:aws:iam::048153540315:role/fancy-task-role"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  task_size:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  cpu_limit: <span class="cm-string">".5 vCPU"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  mem_limit: <span class="cm-string">"2GB"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">run_params:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  awsvpc_configuration:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  subnets:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-</span> <span class="cm-string">"subnet-02a41722148ef4275"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-</span> <span class="cm-string">"subnet-0241ffc69d46c32d9"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  security_groups:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-</span> <span class="cm-string">"sg-0029b5e1065d636b9"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  assign_public_ip: ENABLED</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 345px;"></div><div class="CodeMirror-gutters" style="display: none; height: 345px;"></div></div></div></pre><p><strong><span>^ That is only an example, you need to fill in your details </span><fmi><span>^</span></fmi></strong></p></li><li><p><span>Save it. </span></p></li><li><p><span>Now open the </span><code>resources/for_ecs/price-api/docker-compose.yaml file</code><span>.</span></p><p><span>Replace the content with the following:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">version: <span class="cm-string">"3.0"</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">services:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  price-api:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  image: <span class="cm-string">"&lt;FMI&gt;"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ports:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-</span> <span class="cm-string">"3000:3000"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 138px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre><p><span>Note the PORT needs to show </span><strong><span>3000:3000</span></strong><span> </span>📓<span> This is because Fargate will associate an IP to this task and as we don't have to worry about the host anymore.  We can let Fargate worry about tightly packing its own machines.  We don't care if one or more task are running on a host or not, </span><strong><span>it's not our problem anymore.  It's now a Fargate problem </span>😎<span> .</span></strong><span> </span></p><p><span>Your </span><code>&lt;FMI&gt;</code><span>for the ECR image needs to be the </span><em><span>price</span></em><span> one </span><u><span>not</span></u><span> the service one.</span></p><p><span>Example:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">version: <span class="cm-string">"3.0"</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">services:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  price-api:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  image: <span class="cm-string">"048153540315.dkr.ecr.us-west-2.amazonaws.com/price-api"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ports:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-</span> <span class="cm-string">"3000:3000"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 138px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre></li><li><p><span>This is where the magic happens:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> ~/environment/resources/for_ecs/price-api/</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ecs-cli compose <span class="cm-attribute">--file</span> docker-compose.yaml <span class="cm-attribute">--ecs-params</span> ecs-params.yaml <span class="cm-attribute">--region</span> us-west-2 <span class="cm-attribute">--project-name</span> price-project <span class="cm-attribute">--cluster-config</span> fancy-cluster-2 <span class="cm-attribute">--cluster</span> fancy-cluster-2 create</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p><span>You should see:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">INFO[0000] Using ECS task definition &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-def">TaskDefinition</span><span class="cm-operator">=</span><span class="cm-string">"price-project:2"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>We now have a task definition that is compatible with the Fargate launch type. Now you just need to show them how to set up a new ECS Service to launch these tasks for us. </span></p><p><span>This way we can leverage the same ALB.</span></p><p><span>So like before you simply create an ECS Service in the console, that (due to our ecs-params file earlier) will be compatible with Fargate.</span></p></li><li><p><span>Switch back to the </span><strong><span>ECS</span></strong><span> tab.  Choose </span><strong><span>Clusters</span></strong><span> and </span><strong><span>fancy-cluster-2 &gt;</span></strong><span>.</span></p></li><li><p><span>Under the </span><strong><span>Services</span></strong><span> tab choose </span><strong><span>Create</span></strong><span>.</span></p></li><li><p><span>For </span><strong><span>Launch type</span></strong><span> choose </span><strong><span>FARGATE</span></strong><span>.</span></p></li><li><p><span>Ignore the warning and under </span><strong><span>Task Definition</span></strong><span> choose </span><code>price-project</code><span>.</span></p></li><li><p><span>The </span><strong><span>Platform version</span></strong><span> should show </span><code>LATEST</code><span>, and </span><strong><span>Cluster</span></strong><span> should show </span><code>fancy-cluster-2</code><span>.</span></p></li><li><p><span>For </span><strong><span>Service name</span></strong><span> copy in </span><code>balanced-price</code><span>.</span></p></li><li><p><span>Type in </span><code>30</code><span> for the </span><strong><span>Number of tasks</span></strong><span>.  </span></p></li><li><p><span>Leave the </span><strong><span>Minimum</span></strong><span> and </span><strong><span>Maximum</span></strong><span> percent as is.</span></p></li><li><p><strong><span>Deployment type</span></strong><span> will stay at </span><strong><span>Rolling update</span></strong><span>.</span></p></li><li><p><span>Choose </span><strong><span>Next step</span></strong><span>.  </span></p></li><li><p><span>For </span><strong><span>Cluster VPC</span></strong><span> this will need to match what was output from the </span><code>lab-helper</code><span> script.  </span></p></li><li><p><span>Select both subnets that appear.  Again these will match the output from the </span><code>lab-helper</code><span> script.</span></p></li><li><p><span>For </span><strong><span>Security groups</span></strong><span> choose </span><strong><span>Edit</span></strong><span>.  Choose </span><strong><span>Select existing security group</span></strong><span>.  Select the security group with </span><code>fancy-cluster</code><span> in it.  Choose </span><strong><span>Save</span></strong><span>.  </span></p></li><li><p><span>Leave </span><strong><span>Auto-assign public IP</span></strong><span> as </span><strong><span>ENABLED</span></strong><span>.</span></p></li><li><p><span>For </span><strong><span>Load balancer type</span></strong><span> select </span><strong><span>Application Load Balancer</span></strong><span>.  The </span><strong><span>Load balancer name</span></strong><span> will populate to </span><code>fancy-alb</code><span>.  </span></p></li><li><p><span>Choose </span><strong><span>Add to load balancer</span></strong><span>.  For </span><strong><span>Target group name</span></strong><span> keep this as </span><strong><span>create new</span></strong><span>.  Then call it </span><code>price-target-group</code><span>.  For </span><strong><span>Production listener port</span></strong><span> choose </span><strong><span>80:HTTP</span></strong><span>.</span></p></li><li><p><span>Leave the </span><strong><span>Target group protocol</span></strong><span> as </span><strong><span>HTTP</span></strong><span>.  </span></p></li><li><p><strong><span>Target type</span></strong><span> will be IP (for Fargate) as they use ENIs not ECS directly.  Hence every task is on </span><code>3000</code><span> and not dynamically port mapped.  </span></p></li><li><p><span>Set </span><strong><span>Path pattern</span></strong><span> to </span><code>/remove-me</code><span>.  </span></p></li><li><p><span>Set </span><strong><span>Evaluation order</span></strong><span> to </span><code>100</code><span>.</span></p></li><li><p><span>It should show the existing </span><code>service</code><span> paths for </span><strong><span>Existing paths in use on this listener</span></strong><span>.</span></p></li><li><p><span>Set </span><strong><span>Health check path</span></strong><span> to </span><code>/</code><span>.  As it says "Additional health check options can be configured in the ELB console after you create your service."</span></p></li><li><p><span>Under </span><strong><span>App Mesh</span></strong><span> uncheck </span><strong><span>Enable service discovery integration</span></strong><span>.  </span></p></li><li><p><span>Choose </span><strong><span>Next step</span></strong><span>.  </span></p></li><li><p><span>For </span><strong><span>Service Auto Scaling</span></strong><span> choose </span><strong><span>Configure Service Auto Scaling to adjust your service's desired count</span></strong><span>.</span></p></li><li><p><span>Set the </span><strong><span>Minimum number of tasks</span></strong><span> to </span><code>20</code><span>.  Leave </span><strong><span>Desired number of tasks</span></strong><span> as </span><code>30</code><span>.  Set </span><strong><span>Maximum number of tasks</span></strong><span> to </span><code>40</code><span>.</span></p></li><li><p><span>Leave </span><strong><span>IAM role for Service Auto Scaling</span></strong><span> as </span><strong><span>ecsAutoscaleRole</span></strong><span>.</span></p></li><li><p><span>Leave </span><strong><span>Scaling policy type</span></strong><span> as </span><strong><span>Target tracking</span></strong><span>.</span></p></li><li><p><span>For </span><strong><span>Policy name</span></strong><span> copy in </span><code>price-scaling</code><span>.</span></p></li><li><p><span>Leave </span><strong><span>ECS service metric</span></strong><span> as </span><strong><span>ECSServiceAverageCPUUtilization</span></strong><span>.</span></p></li><li><p><span>Set the </span><strong><span>Target value</span></strong><span> to </span><code>70</code><span>.</span></p></li><li><p><span>Change the </span><strong><span>Scale-out cooldown period</span></strong><span> and </span><strong><span>Scale-in cooldown period</span></strong><span> to </span><code>100</code><span>.</span></p></li><li><p><strong><span>Disable scale-in</span></strong><span> should remain unchecked. </span></p></li><li><p><span>Choose </span><strong><span>Next step</span></strong><span>.  Choose </span><strong><span>Create Service</span></strong><span>.  Then after it completes choose </span><strong><span>View Service</span></strong><span>.</span></p></li><li><p><span>Choose </span><strong><span>Clusters</span></strong><span> then select </span><strong><span>fancy-cluster-2 &gt;</span></strong><span>.  You will now see two services </span><code>balanced-price</code><span> and </span><code>balanced-service</code><span>.  </span></p></li><li><p><span>Choose the </span><strong><span>Tasks</span></strong><span> tab.  You should now see that in addition to </span><strong><span>EC2</span></strong><span> for </span><strong><span>Launch type</span></strong><span> there are now </span><strong><span>FARGATE</span></strong><span> instances.  </span></p></li><li><p><span>Refresh and you should see </span><code>30</code><span> </span><strong><span>FARGATE</span></strong><span> instances and </span><code>5</code><span> </span><strong><span>EC2</span></strong><span> instances.  Over time the </span><strong><span>FARGATE</span></strong><span> tasks should drop to </span><code>20</code><span> if there is low CPU.</span></p></li><li><p><span>Click on one of the hyperlinks under the </span><strong><span>Task</span></strong><span> group.  Make sure it's one that contains </span><strong><span>Task definition</span></strong><span> </span><code>price-project:</code></p></li><li><p><span>At the bottom under </span><strong><span>Network</span></strong><span> you will find the </span><strong><span>Public IP</span></strong><span>.  Append </span><code>:3000</code><span> to the end and view it in a browser.  </span></p></li><li><p><span>You should see the following:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">hello this is the root of the price api</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><strong><span>Awesome</span></strong><span> you have a single cluster using both Fargate tasks and EC2 launch tasks! #WIN.  However you STILL have one mores step to demo: </span><em><span>How to share the ALB</span></em><span>.</span></p></li></ol><h2><a name="step-7---final-step" class="md-header-anchor"></a><span>Step 7 - final step</span></h2><p><span>At this point you should have between 30 and 20 Fargate tasks running and between 2 and 8 EC2 tasks running on your cluster.  </span></p><p><span>Its time to wrap up your session today, by linking the existing ALB to the Price API tasks on Fargate.</span></p><p><span>You want to be able to go to </span><code>/price</code><span> and </span><code>/price/get-prices</code><span> from the same ALB.</span></p><p><span>So you start with setting up the </span><code>/price</code><span> path:</span></p><ol start=""><li><p><span>Choose </span><strong><span>Services</span></strong><span> and choose </span><strong><span>EC2</span></strong><span>.  Then choose </span><strong><span>Load Balancers</span></strong><span>.</span></p></li><li><p><span>Choose the </span><strong><span>Listeners</span></strong><span> tab and choose </span><strong><span>View/edit rules</span></strong><span>.  </span></p></li><li><p><span>Choose the </span><strong><span>Plus</span></strong><span> icon at the top left.  Choose </span><strong><span>Insert Rule</span></strong><span>.  </span></p></li><li><p><span>For </span><strong><span>IF (all match)</span></strong><span> choose </span><strong><span>Add condition</span></strong><span>.  Choose </span><strong><span>Path...</span></strong><span> and type in </span><code>/price</code><span>.  Choose the </span><strong><span>checkmark</span></strong><span> icon.</span></p></li><li><p><span>At the right under </span><strong><span>THEN</span></strong><span> choose </span><strong><span>Add action</span></strong><span> and select </span><strong><span>Return fixed response...</span></strong><span>.</span></p></li><li><p><span>Set the </span><strong><span>Response code</span></strong><span> to </span><code>200</code><span>.  Leave </span><strong><span>Content-Type</span></strong><span> as </span><code>text/plain</code><span>.  For </span><strong><span>Response body</span></strong><span> paste in the following:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Choose a price method. &nbsp;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p><span>Choose the </span><strong><span>checkmark</span></strong><span> and then choose </span><strong><span>Save</span></strong><span>.  </span></p></li><li><p><span>Choose </span><strong><span>Insert Rule</span></strong><span> again.  For </span><strong><span>IF (all match)</span></strong><span> choose </span><strong><span>Add condition</span></strong><span>.  Choose </span><strong><span>Path...</span></strong><span> and paste in </span><code>/price/*</code><span>.   Choose the </span><strong><span>checkmark</span></strong><span> icon.  </span></p></li><li><p><span>For </span><strong><span>THEN</span></strong><span> select </span><strong><span>Add action</span></strong><span>, choose </span><strong><span>Forward to...</span></strong><span> and select the </span><code>price-target-group</code><span>.  Choose the </span><strong><span>checkmark</span></strong><span> icon and then choose </span><strong><span>Save</span></strong><span>.  </span></p><p><span>It should look something like the following in the end:</span></p></li></ol><p><img src="./Screen Shot 2019-12-30 at 12.29.03 PM.png" referrerpolicy="no-referrer" alt="Screen Shot 2019-12-30 at 12.29.03 PM"></p><ol start="10"><li><p><span>Finally you need to check the ALB endpoint. This can be found under the </span><strong><span>Description</span></strong><span> tab in </span><strong><span>EC2</span></strong><span> and </span><strong><span>Load Balancers</span></strong><span>.  </span></p></li><li><p><span>You demo the following:</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> http://fancy-alb-56179038.us-west-2.elb.amazonaws.com/price</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Choose a price method</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> http://fancy-alb-56179038.us-west-2.elb.amazonaws.com/price/get-prices</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#{"price_arr":["134.50","455.99"]}</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> http://fancy-alb-56179038.us-west-2.elb.amazonaws.com/service</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Choose a method of service</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> http://fancy-alb-56179038.us-west-2.elb.amazonaws.com/service/get-service-area</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#{"cities_arr":["vegas","chicago"]}</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> http://fancy-alb-56179038.us-west-2.elb.amazonaws.com/</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Please choose an API (service or price)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre></li></ol><p><span>Awesome!</span></p><p><span>Everything is working, your students seem very happy with what they have learned in the short time you have had together.</span></p><p><span>You ask them if they have any final questions. </span></p><p><span>No questions...you are surprised, but kind of relieved at the same time.</span></p><p><span>Although some of the students are already packing up their laptops and throwing away their coffee cups, you tell them you just want to cover a </span><u><span>couple of points</span></u><span> before you let them go.</span></p><p><span>You think it makes sense to close out with a few comments on where they can go from here.</span></p><p><span>So before they leave the room you mention these things to them (mostly just to recap some important takeaways).</span></p><ul><li><span>If you wanted to have shared data when you are sharing Fargate tasks with EC2 based tasks, you would recommend that they use things like S3 or DynamoDB rather than trying to seed EBS volumes. You suspect that this will also be possible with EFS at some point too.</span></li><li><span>You advise them they should consider having tasks with just 1 container so they scale independently</span></li><li><span>You recommend using Beanstalk unless they need to use ECS to tightly pack machines, as its simpler to use. This is especially true if they are not big into setting up custom VPCs etc.</span></li><li><span>Your final tip, is for them to look into CloudFormation for building all of this Infrastructure, so that they have a repeatable template for development and production, And to save having to jump around the console with placeholder ALBs and the like.</span></li></ul><p><span>Ok, you call tell that they are all nodding and happy, but mostly its that that are itching to go home.</span></p><p><span>So you thank them for their attention, and off everyone goes. They all systematically shake your hand on their way out, all very grateful to you for all your help.</span></p><p><span>Great job trainer! </span>😎<span> Well done 👍 </span></p><h3><a name="lab-complete" class="md-header-anchor"></a><span>Lab Complete</span></h3><p><span>	</span><span> Congratulations! You have completed the lab.</span></p><ol><li><span>Click </span><strong><span>End Lab</span></strong><span> at the top of this page and then click </span><strong><span>Yes</span></strong><span> to confirm that you want to end the lab.</span></li><li><span>A panel will appear, indicating that "DELETE has been initiated... You may close this message box now."</span></li><li><span>Click the </span><strong><span>X</span></strong><span> in the top right corner to close the panel.</span></li></ol><p><span>	</span><span>For feedback, suggestions, or corrections, please visit:</span><a href="https://support.aws.amazon.com/#/contacts/aws-training" target="_blank" class="url">https://support.aws.amazon.com/#/contacts/aws-training</a></p><p>&nbsp;</p></div>

</body></html>